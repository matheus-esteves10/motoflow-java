<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Motoflow - App</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="m-0 font-sans bg-gray-100">
<div th:replace="~{fragments/header :: header}"></div>

<div class="flex h-[calc(100vh-60px)]">
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar(${patioId})}"></div>

    <!-- Conteúdo -->
    <main id="mainContent" class="flex-1 p-6 overflow-auto">
        <p class="text-gray-600 italic">Escolha uma opção no menu ao lado.</p>
    </main>
</div>

<script>
    function loadContent(url) {
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = '<div class="text-center text-gray-500 italic">Carregando...</div>';

        fetch(url)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const container = doc.querySelector('.container');

                if (container) {
                    mainContent.innerHTML = container.outerHTML;
                } else {
                    mainContent.innerHTML = html;
                }

                applyPageSpecificStyles();
                applyUsuariosListeners();
            })
            .catch(error => {
                mainContent.innerHTML = '<div class="text-red-600">Erro ao carregar conteúdo: ' + error.message + '</div>';
            });
    }

    function applyPageSpecificStyles() {
        const mainContent = document.getElementById('mainContent');

        if (mainContent.querySelector('#patioChart')) {
            const patioId = document.querySelector('.sidebar h2').textContent.match(/\d+/)[0];
            loadDashboardData(patioId);
        }
    }

    function applyUsuariosListeners() {
        const mainContent = document.getElementById('mainContent');
        const formCadastro = mainContent.querySelector('form[method="post"]');
        if (formCadastro) {
            formCadastro.addEventListener('submit', function(e) {
                e.preventDefault();
                const data = new FormData(formCadastro);
                fetch(formCadastro.action, {
                    method: 'POST',
                    body: data
                })
                .then(response => response.redirected ? fetch(response.url) : response.text())
                .then(res => res.text ? res.text() : res)
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const container = doc.querySelector('.container');
                    if (container) {
                        mainContent.innerHTML = container.outerHTML;
                        applyUsuariosListeners();
                    }
                });
            });
        }
        // Listeners para exclusão
        const deleteForms = mainContent.querySelectorAll('form.inline');
        deleteForms.forEach(function(form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const data = new FormData(form);
                fetch(form.action, {
                    method: 'POST',
                    body: data
                })
                .then(response => response.redirected ? fetch(response.url) : response.text())
                .then(res => res.text ? res.text() : res)
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const container = doc.querySelector('.container');
                    if (container) {
                        mainContent.innerHTML = container.outerHTML;
                        applyUsuariosListeners();
                    }
                });
            });
        });
    }

    function loadDashboardData(patioId) {
        fetch(`/patio/${patioId}/stats`)
            .then(response => response.json())
            .then(data => createDashboardChart(data))
            .catch(error => {
                console.error('Erro ao carregar dados do pátio:', error);
                createDashboardChart({ posicoesDisponiveis: 0, quantidadeAlugadas: 0 });
            });
    }

    function createDashboardChart(data) {
        const canvas = document.querySelector('#patioChart');
        const ctx = canvas.getContext('2d');

        if (canvas.chart) {
            canvas.chart.destroy();
        }

        canvas.chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Posições Disponíveis', 'Posições Alugadas'],
                datasets: [{
                    label: 'Ocupação do Pátio',
                    data: [data.posicoesDisponiveis, data.quantidadeAlugadas],
                    backgroundColor: ['#e0e0e0', '#0d7000'],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 14 } }
                    }
                }
            }
        });
    }
</script>
</body>
</html>
